<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="模块介绍通用模块ImageSourceKingfisher中对图片资源的表示有两种，定义在Source枚举中。 1234public enum Source &amp;#123;  case network(Resource)  case provider(ImageDataProvider)&amp;#125;  network类型的需要提供一个url和cacheKey，然后kingfisher会自行下载。pr">
<meta name="keywords" content="iOS,源码,Swift">
<meta property="og:type" content="article">
<meta property="og:title" content="kingfisher源码阅读">
<meta property="og:url" content="http://yoursite.com/2019/07/01/kingfisher源码阅读/index.html">
<meta property="og:site_name" content="软件开发实践学习记录">
<meta property="og:description" content="模块介绍通用模块ImageSourceKingfisher中对图片资源的表示有两种，定义在Source枚举中。 1234public enum Source &amp;#123;  case network(Resource)  case provider(ImageDataProvider)&amp;#125;  network类型的需要提供一个url和cacheKey，然后kingfisher会自行下载。pr">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-07-30T11:48:19.506Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kingfisher源码阅读">
<meta name="twitter:description" content="模块介绍通用模块ImageSourceKingfisher中对图片资源的表示有两种，定义在Source枚举中。 1234public enum Source &amp;#123;  case network(Resource)  case provider(ImageDataProvider)&amp;#125;  network类型的需要提供一个url和cacheKey，然后kingfisher会自行下载。pr">



  <link rel="alternate" href="/atom.xml" title="软件开发实践学习记录" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://yoursite.com/2019/07/01/kingfisher源码阅读/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>kingfisher源码阅读 | 软件开发实践学习记录</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">软件开发实践学习记录</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/01/kingfisher源码阅读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="冰川">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="软件开发实践学习记录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">kingfisher源码阅读

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-01 16:05:22" itemprop="dateCreated datePublished" datetime="2019-07-01T16:05:22+08:00">2019-07-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-30 19:48:19" itemprop="dateModified" datetime="2019-07-30T19:48:19+08:00">2019-07-30</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h2><h3 id="通用模块"><a href="#通用模块" class="headerlink" title="通用模块"></a>通用模块</h3><h4 id="ImageSource"><a href="#ImageSource" class="headerlink" title="ImageSource"></a>ImageSource</h4><p>Kingfisher中对图片资源的表示有两种，定义在Source枚举中。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Source</span> </span>&#123;</span><br><span class="line">  <span class="keyword">case</span> network(<span class="type">Resource</span>)</span><br><span class="line">  <span class="keyword">case</span> provider(<span class="type">ImageDataProvider</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>network</code>类型的需要提供一个url和cacheKey，然后kingfisher会自行下载。provider类型的，是自己提供image数据。下面看下Resource</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// The key used in cache.</span></span><br><span class="line">    <span class="keyword">var</span> cacheKey: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// The target image URL.</span></span><br><span class="line">    <span class="keyword">var</span> downloadURL: <span class="type">URL</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Resource的协议需要两个属性，下载地址和缓存key。正常情况下我们无需实现这个Resource，因为Kingfisher中的URL通过extension实现了这个协议，我们平常直接用URL就可以了。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">URL</span>: <span class="title">Resource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> cacheKey: <span class="type">String</span> &#123; <span class="keyword">return</span> absoluteString &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> downloadURL: <span class="type">URL</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，如果你想定制key的格式，可以使用Resource的另一个实现。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">ImageResource</span>: <span class="title">Resource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(downloadURL: <span class="type">URL</span>, cacheKey: <span class="type">String?</span> = <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.downloadURL = downloadURL</span><br><span class="line">        <span class="keyword">self</span>.cacheKey = cacheKey ?? downloadURL.absoluteString</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> cacheKey: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> downloadURL: <span class="type">URL</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ImageDataProvider 提供了三个实现，分别是<code>LocalFileImageDataProvider</code>，<code>Base64ImageDataProvider</code>，<code>RawImageDataProvider</code>。三种方式提供image的data，不过这个没什么使用场景，源码中，也只在测试的地方有用到。</p>
<h4 id="KingfisherError"><a href="#KingfisherError" class="headerlink" title="KingfisherError"></a>KingfisherError</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">KingfisherError</span>: <span class="title">Error</span> </span>&#123;</span><br><span class="line">	<span class="comment">/// Represents the error reason during networking request phase.</span></span><br><span class="line">    <span class="keyword">case</span> requestError(reason: <span class="type">RequestErrorReason</span>)</span><br><span class="line">    <span class="comment">/// Represents the error reason during networking response phase.</span></span><br><span class="line">    <span class="keyword">case</span> responseError(reason: <span class="type">ResponseErrorReason</span>)</span><br><span class="line">    <span class="comment">/// Represents the error reason during Kingfisher caching system.</span></span><br><span class="line">    <span class="keyword">case</span> cacheError(reason: <span class="type">CacheErrorReason</span>)</span><br><span class="line">    <span class="comment">/// Represents the error reason during image processing phase.</span></span><br><span class="line">    <span class="keyword">case</span> processorError(reason: <span class="type">ProcessorErrorReason</span>)</span><br><span class="line">    <span class="comment">/// Represents the error reason during image setting in a view related class.</span></span><br><span class="line">    <span class="keyword">case</span> imageSettingError(reason: <span class="type">ImageSettingErrorReason</span>) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Kingfisher 将 error 按照过程划分，分别是请求，返回，缓存，处理，设置，每个过程一种 error 类型。</p>
<p>###下载</p>
<p>当缓存没有命中的时候，就会启动一个下载。下载主要用到两个类，<code>ImageDownloader</code>启动下载，并处理回调，SessionDelegate处理URLSessionDataTask的下载代理，并提供任务管理功能。图片下载过程中，会通过<code>ImageDownloaderDelegate</code>通知外部。</p>
<p>此外可以通过ImageDownloadRequestModifier拦截修改图片的url。</p>
<h3 id="图片处理"><a href="#图片处理" class="headerlink" title="图片处理"></a>图片处理</h3><p>Kingfisher提供丰富的图片处理功能。这些功能通过<code>ImageProcessor</code>来提供，如果有需要其他的处理，可以自行实现这个协议来提供，比如webp格式的图片处理。</p>
<p>Kingfisher在demo中列出了目前已经提供了的。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="type">DefaultImageProcessor</span>.<span class="keyword">default</span>, <span class="string">"Default"</span>),</span><br><span class="line">(<span class="type">RoundCornerImageProcessor</span>(cornerRadius: <span class="number">20</span>), <span class="string">"Round Corner"</span>),</span><br><span class="line">(<span class="type">RoundCornerImageProcessor</span>(cornerRadius: <span class="number">20</span>, roundingCorners: [.topLeft, .bottomRight]), <span class="string">"Round Corner Partial"</span>),</span><br><span class="line">(<span class="type">BlendImageProcessor</span>(blendMode: .lighten, alpha: <span class="number">1.0</span>, backgroundColor: .red), <span class="string">"Blend"</span>),</span><br><span class="line">(<span class="type">BlurImageProcessor</span>(blurRadius: <span class="number">5</span>), <span class="string">"Blur"</span>),</span><br><span class="line">(<span class="type">OverlayImageProcessor</span>(overlay: .red, fraction: <span class="number">0.5</span>), <span class="string">"Overlay"</span>),</span><br><span class="line">(<span class="type">TintImageProcessor</span>(tint: <span class="type">UIColor</span>.red.withAlphaComponent(<span class="number">0.5</span>)), <span class="string">"Tint"</span>),</span><br><span class="line">(<span class="type">ColorControlsProcessor</span>(brightness: <span class="number">0.0</span>, contrast: <span class="number">1.1</span>, saturation: <span class="number">1.1</span>, inputEV: <span class="number">1.0</span>), <span class="string">"Vibrancy"</span>),</span><br><span class="line">(<span class="type">BlackWhiteProcessor</span>(), <span class="string">"B&amp;W"</span>),</span><br><span class="line">(<span class="type">CroppingImageProcessor</span>(size: <span class="type">CGSize</span>(width: <span class="number">100</span>, height: <span class="number">100</span>)), <span class="string">"Cropping"</span>),</span><br><span class="line">(<span class="type">DownsamplingImageProcessor</span>(size: <span class="type">CGSize</span>(width: <span class="number">25</span>, height: <span class="number">25</span>)), <span class="string">"Downsampling"</span>),</span><br><span class="line">(<span class="type">BlurImageProcessor</span>(blurRadius: <span class="number">5</span>) &gt;&gt; <span class="type">RoundCornerImageProcessor</span>(cornerRadius: <span class="number">20</span>), <span class="string">"Blur + Round Corner"</span>)</span><br></pre></td></tr></table></figure>

<p>这些功能主要通过 <code>ImageDrawing</code>中的方法来实现。</p>
<p>####圆角</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">image</span><span class="params">(withRoundRadius radius: CGFloat,</span></span></span><br><span class="line"><span class="function"><span class="params">                  fit size: CGSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                  roundingCorners corners: RectCorner = .all,</span></span></span><br><span class="line"><span class="function"><span class="params">                  backgroundColor: Color? = <span class="literal">nil</span>)</span></span> -&gt; <span class="type">Image</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> rect = <span class="type">CGRect</span>(origin: <span class="type">CGPoint</span>(x: <span class="number">0</span>, y: <span class="number">0</span>), size: size)</span><br><span class="line">    <span class="keyword">return</span> draw(to: size) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> context = <span class="type">UIGraphicsGetCurrentContext</span>() <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">assertionFailure</span>(<span class="string">"[Kingfisher] Failed to create CG context for image."</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> backgroundColor = backgroundColor &#123;</span><br><span class="line">            <span class="keyword">let</span> rectPath = <span class="type">UIBezierPath</span>(rect: rect)</span><br><span class="line">            backgroundColor.setFill()</span><br><span class="line">            rectPath.fill()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> path = <span class="type">UIBezierPath</span>(</span><br><span class="line">            roundedRect: rect,</span><br><span class="line">            byRoundingCorners: corners.uiRectCorner,</span><br><span class="line">            cornerRadii: <span class="type">CGSize</span>(width: radius, height: radius)</span><br><span class="line">        )</span><br><span class="line">        context.addPath(path.cgPath)</span><br><span class="line">        context.clip()</span><br><span class="line">        base.draw(<span class="keyword">in</span>: rect)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>draw</code>方法负责开启上下文和关闭上下文，block中是绘制的主要代码。</p>
<h4 id="模糊"><a href="#模糊" class="headerlink" title="模糊"></a>模糊</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">blurred</span><span class="params">(withRadius radius: CGFloat)</span></span> -&gt; <span class="type">Image</span> &#123;</span><br><span class="line">    <span class="comment">// http://www.w3.org/TR/SVG/filters.html#feGaussianBlurElement</span></span><br><span class="line">    <span class="comment">// let d = floor(s * 3*sqrt(2*pi)/4 + 0.5)</span></span><br><span class="line">    <span class="comment">// if d is odd, use three box-blurs of size 'd', centered on the output pixel.</span></span><br><span class="line">    <span class="keyword">let</span> s = <span class="type">Float</span>(<span class="built_in">max</span>(radius, <span class="number">2.0</span>))</span><br><span class="line">    <span class="comment">// We will do blur on a resized image (*0.5), so the blur radius could be half as well.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Fix the slow compiling time for Swift 3.</span></span><br><span class="line">    <span class="comment">// See https://github.com/onevcat/Kingfisher/issues/611</span></span><br><span class="line">    <span class="keyword">let</span> pi2 = <span class="number">2</span> * <span class="type">Float</span>.pi</span><br><span class="line">    <span class="keyword">let</span> sqrtPi2 = sqrt(pi2)</span><br><span class="line">    <span class="keyword">var</span> targetRadius = floor(s * <span class="number">3.0</span> * sqrtPi2 / <span class="number">4.0</span> + <span class="number">0.5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> targetRadius.isEven &#123; targetRadius += <span class="number">1</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine necessary iteration count by blur radius.</span></span><br><span class="line">    <span class="keyword">let</span> iterations: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">if</span> radius &lt; <span class="number">0.5</span> &#123;</span><br><span class="line">        iterations = <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> radius &lt; <span class="number">1.5</span> &#123;</span><br><span class="line">        iterations = <span class="number">2</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        iterations = <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> w = <span class="type">Int</span>(size.width)</span><br><span class="line">    <span class="keyword">let</span> h = <span class="type">Int</span>(size.height)</span><br><span class="line">    <span class="keyword">let</span> rowBytes = <span class="type">Int</span>(<span class="type">CGFloat</span>(cgImage.bytesPerRow))</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">createEffectBuffer</span><span class="params">(<span class="number">_</span> context: CGContext)</span></span> -&gt; vImage_Buffer &#123;</span><br><span class="line">        <span class="keyword">let</span> data = context.data</span><br><span class="line">        <span class="keyword">let</span> width = vImagePixelCount(context.width)</span><br><span class="line">        <span class="keyword">let</span> height = vImagePixelCount(context.height)</span><br><span class="line">        <span class="keyword">let</span> rowBytes = context.bytesPerRow</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> vImage_Buffer(data: data, height: height, width: width, rowBytes: rowBytes)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> context = beginContext(size: size, scale: scale, inverting: <span class="literal">true</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">assertionFailure</span>(<span class="string">"[Kingfisher] Failed to create CG context for blurring image."</span>)</span><br><span class="line">        <span class="keyword">return</span> base</span><br><span class="line">    &#125;</span><br><span class="line">    context.draw(cgImage, <span class="keyword">in</span>: <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: w, height: h))</span><br><span class="line">    endContext()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> inBuffer = createEffectBuffer(context)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> outContext = beginContext(size: size, scale: scale, inverting: <span class="literal">true</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">assertionFailure</span>(<span class="string">"[Kingfisher] Failed to create CG context for blurring image."</span>)</span><br><span class="line">        <span class="keyword">return</span> base</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> &#123; endContext() &#125;</span><br><span class="line">    <span class="keyword">var</span> outBuffer = createEffectBuffer(outContext)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span> ..&lt; iterations &#123;</span><br><span class="line">        <span class="keyword">let</span> flag = vImage_Flags(kvImageEdgeExtend)</span><br><span class="line">        vImageBoxConvolve_ARGB8888(</span><br><span class="line">            &amp;inBuffer, &amp;outBuffer, <span class="literal">nil</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="type">UInt32</span>(targetRadius), <span class="type">UInt32</span>(targetRadius), <span class="literal">nil</span>, flag)</span><br><span class="line">        <span class="comment">// Next inBuffer should be the outButter of current iteration</span></span><br><span class="line">        (inBuffer, outBuffer) = (outBuffer, inBuffer)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> result = outContext.makeImage().flatMap &#123;</span><br><span class="line">        <span class="type">Image</span>(cgImage: $<span class="number">0</span>, scale: base.scale, orientation: base.imageOrientation)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> blurredImage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模糊是通过Accelerate.framework中的vImage实现，使用vImage来做比较自由，但是比较麻烦，需要了解算法细节。</p>
<p>其他的诸如Size，blend都比较简单。</p>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><h4 id="缓存策略"><a href="#缓存策略" class="headerlink" title="缓存策略"></a>缓存策略</h4><p>Kingfisher有两个关于缓存策略的枚举，<code>StorageExpiration</code>用来表示文件创建成功后的缓存策略。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">StorageExpiration</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// The item never expires.</span></span><br><span class="line">    <span class="keyword">case</span> never</span><br><span class="line">    <span class="comment">/// The item expires after a time duration of given seconds from now.</span></span><br><span class="line">    <span class="keyword">case</span> seconds(<span class="type">TimeInterval</span>)</span><br><span class="line">    <span class="comment">/// The item expires after a time duration of given days from now.</span></span><br><span class="line">    <span class="keyword">case</span> days(<span class="type">Int</span>)</span><br><span class="line">    <span class="comment">/// The item expires after a given date.</span></span><br><span class="line">    <span class="keyword">case</span> date(<span class="type">Date</span>)</span><br><span class="line">    <span class="comment">/// Indicates the item is already expired. Use this to skip cache.</span></span><br><span class="line">    <span class="keyword">case</span> expired</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ExpirationExtending</code>用来表示再次访问后，如何更新该文件的缓存策略。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">ExpirationExtending</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// The item expires after the original time, without extending after access.</span></span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">none</span></span><br><span class="line">    <span class="comment">/// The item expiration extends by the original cache time after each access.</span></span><br><span class="line">    <span class="keyword">case</span> cacheTime</span><br><span class="line">    <span class="comment">/// The item expiration extends by the provided time after each access.</span></span><br><span class="line">    <span class="keyword">case</span> expirationTime(<span class="number">_</span> expiration: <span class="type">StorageExpiration</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="内存缓存"><a href="#内存缓存" class="headerlink" title="内存缓存"></a>内存缓存</h4><p>kingfisher内存缓存<code>MemoryStorage</code>定义了一个命名空间，里面有三个对象，<code>Config</code>，<code>StorageObject</code>和实际用来做处理的<code>Backend</code>。</p>
<p><code>StorageObject</code>包括数据value，过期策略，和缓存的key值。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StorageObject</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value: <span class="type">T</span></span><br><span class="line">  <span class="keyword">let</span> expiration: <span class="type">StorageExpiration</span></span><br><span class="line">  <span class="keyword">let</span> key: <span class="type">String</span>        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>缓存配置对象</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MemoryStorage</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Represents the config used in a `MemoryStorage`.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="comment">//缓存容量上限</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">var</span> totalCostLimit: <span class="type">Int</span></span><br><span class="line">        <span class="comment">//缓存数量上限</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">var</span> countLimit: <span class="type">Int</span> = .<span class="built_in">max</span></span><br><span class="line">        <span class="comment">//过期策略</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">var</span> expiration: <span class="type">StorageExpiration</span> = .seconds(<span class="number">300</span>)</span><br><span class="line">        <span class="comment">//清理周期</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">let</span> cleanInterval: <span class="type">TimeInterval</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际做内存缓存处理的类<code>Backend</code>，以<code>NSCache</code>为存储源，将需要存储的数据构造成<code>StorageObject</code>来存储。提供存储，移除，查询三个功能，在查到缓存的时候，会根据延长缓存策略，更新这个对象的缓存策略。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">value</span><span class="params">(forKey key: String, extendingExpiration: ExpirationExtending = .cacheTime)</span></span> -&gt; <span class="type">T?</span> &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> object = storage.object(forKey: key <span class="keyword">as</span> <span class="type">NSString</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> object.expired &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    object.extendExpiration(extendingExpiration)</span><br><span class="line">    <span class="keyword">return</span> object.value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外，会创建一个Timer，每隔一段时间（config中配置的）清理一次NSCache中过期的对象。</p>
<p>对NSCache的操作，都需要加锁，这里使用的NSLock。</p>
<h4 id="磁盘缓存"><a href="#磁盘缓存" class="headerlink" title="磁盘缓存"></a>磁盘缓存</h4><p>磁盘缓存的结构跟内存缓存类似，使用DiskStorage枚举构造一个命名空间。内部定义了三个结构，配置信息<code>Config</code>，代表磁盘文件的<code>FileMeta</code>，以及处理逻辑的<code>Backend</code>。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">    <span class="comment">//文件大小上限</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> sizeLimit: <span class="type">UInt</span></span><br><span class="line">    <span class="comment">//过期策略</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> expiration: <span class="type">StorageExpiration</span> = .days(<span class="number">7</span>)</span><br><span class="line">    <span class="comment">//文件后缀</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> pathExtension: <span class="type">String?</span> = <span class="literal">nil</span></span><br><span class="line">    <span class="comment">//是否使用hash值来表示文件名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> usesHashedFileName = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FileMeta</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> url: <span class="type">URL</span>    </span><br><span class="line">    <span class="keyword">let</span> lastAccessDate: <span class="type">Date?</span></span><br><span class="line">    <span class="keyword">let</span> estimatedExpirationDate: <span class="type">Date?</span></span><br><span class="line">    <span class="keyword">let</span> isDirectory: <span class="type">Bool</span></span><br><span class="line">    <span class="keyword">let</span> fileSize: <span class="type">Int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>磁盘缓存的数据源是磁盘，在查询，删除，存储上，比内存缓存要麻烦一点。</p>
<p><code>Backend&lt;T: DataTransformable&gt;</code>这里T是内部使用的数据类型。<code>DataTransformable</code>协议定义了T与Data的变换。需要存储时，要从T类型中拿到Data。下面看下store方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">store</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    value: T,</span></span></span><br><span class="line"><span class="function"><span class="params">    forKey key: String,</span></span></span><br><span class="line"><span class="function"><span class="params">    expiration: StorageExpiration? = <span class="literal">nil</span>)</span></span> <span class="keyword">throws</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//缓存失效策略</span></span><br><span class="line">    <span class="keyword">let</span> expiration = expiration ?? config.expiration</span><br><span class="line">    <span class="keyword">guard</span> !expiration.isExpired <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//拿到数据Data</span></span><br><span class="line">    <span class="keyword">let</span> data: <span class="type">Data</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        data = <span class="keyword">try</span> value.toData()</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="type">KingfisherError</span>.cacheError(reason: .cannotConvertToData(object: value, error: error))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据key构建存储的url</span></span><br><span class="line">    <span class="keyword">let</span> fileURL = cacheFileURL(forKey: key)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造文件属性：创建时间，更新时间（其实是过期时间）</span></span><br><span class="line">    <span class="keyword">let</span> now = <span class="type">Date</span>()</span><br><span class="line">    <span class="keyword">let</span> attributes: [<span class="type">FileAttributeKey</span> : <span class="type">Any</span>] = [</span><br><span class="line">        <span class="comment">// The last access date.</span></span><br><span class="line">        .creationDate: now.fileAttributeDate,</span><br><span class="line">        <span class="comment">// The estimated expiration date.</span></span><br><span class="line">        .modificationDate: expiration.estimatedExpirationSinceNow.fileAttributeDate</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment">//创建文件</span></span><br><span class="line">    config.fileManager.createFile(atPath: fileURL.path, contents: data, attributes: attributes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存储文件带的属性，将创建时间和过期时间放进去。方便后续的处理。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">value</span><span class="params">(forKey key: String, referenceDate: Date, actuallyLoad: Bool)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">T?</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> fileManager = config.fileManager</span><br><span class="line">    <span class="keyword">let</span> fileURL = cacheFileURL(forKey: key)</span><br><span class="line">    <span class="keyword">let</span> filePath = fileURL.path</span><br><span class="line">    <span class="keyword">guard</span> fileManager.fileExists(atPath: filePath) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取文件的meta信息，主要是创建时间，和过期时间</span></span><br><span class="line">    <span class="keyword">let</span> meta: <span class="type">FileMeta</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> resourceKeys: <span class="type">Set</span>&lt;<span class="type">URLResourceKey</span>&gt; = [.contentModificationDateKey, .creationDateKey]</span><br><span class="line">        meta = <span class="keyword">try</span> <span class="type">FileMeta</span>(fileURL: fileURL, resourceKeys: resourceKeys)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="type">KingfisherError</span>.cacheError(</span><br><span class="line">            reason: .invalidURLResource(error: error, key: key, url: fileURL))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//过期则返回nil</span></span><br><span class="line">    <span class="keyword">if</span> meta.expired(referenceDate: referenceDate) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//actuallyLoad为false，表明是为了查询，并不需要加载这个数据</span></span><br><span class="line">    <span class="keyword">if</span> !actuallyLoad &#123; <span class="keyword">return</span> <span class="type">T</span>.empty &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//读取数据，修改过期时间</span></span><br><span class="line">        <span class="keyword">let</span> data = <span class="keyword">try</span> <span class="type">Data</span>(contentsOf: fileURL)</span><br><span class="line">        <span class="keyword">let</span> obj = <span class="keyword">try</span> <span class="type">T</span>.fromData(data)</span><br><span class="line">        metaChangingQueue.async &#123; meta.extendExpiration(with: fileManager) &#125;</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="type">KingfisherError</span>.cacheError(reason: .cannotLoadDataFromDisk(url: fileURL, error: error))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>磁盘缓存没有定时清理。App将要进入后台，被杀死和被挂起的时候，会做一次清理。</p>
<h5 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h5><p><strong>文件写入</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> now = <span class="type">Date</span>()</span><br><span class="line"><span class="keyword">let</span> attributes: [<span class="type">FileAttributeKey</span> : <span class="type">Any</span>] = [</span><br><span class="line">    <span class="comment">// The last access date.</span></span><br><span class="line">    .creationDate: now.fileAttributeDate,</span><br><span class="line">    <span class="comment">// The estimated expiration date.</span></span><br><span class="line">    .modificationDate: expiration.estimatedExpirationSinceNow.fileAttributeDate</span><br><span class="line">]</span><br><span class="line"><span class="comment">//创建文件</span></span><br><span class="line">config.fileManager.createFile(atPath: fileURL.path, contents: data, attributes: attributes)</span><br></pre></td></tr></table></figure>

<p>缓存的文件写入是通过<code>FileMananger</code>的<code>open func createFile(atPath path: String, contents data: Data?, attributes attr: [FileAttributeKey : Any]? = nil) -&gt; Bool</code>方法写入，在创建时间和修改时间属性中填入当前时间和过期时间。后续可以根据过期时间来清理磁盘。</p>
<p><strong>文件属性的操作</strong></p>
<p>读取文件属性可以通过<code>url</code>的<code>resourceValues</code>方法，如下</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> resourceKeys: <span class="type">Set</span>&lt;<span class="type">URLResourceKey</span>&gt; = [.contentModificationDateKey, .creationDateKey]</span><br><span class="line"><span class="keyword">let</span> meta = <span class="keyword">try</span> fileURL.resourceValues(forKeys: resourceKeys)</span><br></pre></td></tr></table></figure>

<p>文件的属性很多，需要了解更多的，可以查看<code>URLResourceKey</code>这个结构体。库中主要用到了</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改时间，实际存储的是过期时间</span></span><br><span class="line">contentModificationDateKey</span><br><span class="line"><span class="comment">//创建时间</span></span><br><span class="line">creationDateKey</span><br><span class="line"><span class="comment">//文件大小</span></span><br><span class="line">fileSizeKey</span><br><span class="line"><span class="comment">//是否是目录</span></span><br><span class="line">isDirectoryKey</span><br></pre></td></tr></table></figure>

<p>文件属性的修改则是通过<code>FileManager</code>来处理</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> attributes: [<span class="type">FileAttributeKey</span> : <span class="type">Any</span>] = [</span><br><span class="line">                .creationDate: <span class="type">Date</span>().fileAttributeDate,</span><br><span class="line">                .modificationDate: .estimatedExpirationSinceNow.fileAttributeDate</span><br><span class="line">            ]</span><br><span class="line"><span class="keyword">try</span>? fileManager.setAttributes(attributes, ofItemAtPath: url.path)</span><br></pre></td></tr></table></figure>

<p>文件数据的读入，比较简单</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = <span class="keyword">try</span> <span class="type">Data</span>(contentsOf: fileURL)</span><br></pre></td></tr></table></figure>

<h4 id="ImageCache"><a href="#ImageCache" class="headerlink" title="ImageCache"></a>ImageCache</h4><p><code>ImageCache</code>包装了磁盘缓存和内存缓存，对外提供简单的查询，存储，清除等功能。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">store(<span class="number">_</span> image: <span class="type">Image</span>,</span><br><span class="line">                original: <span class="type">Data?</span> = <span class="literal">nil</span>,</span><br><span class="line">                forKey key: <span class="type">String</span>,</span><br><span class="line">                options: <span class="type">KingfisherParsedOptionsInfo</span>,</span><br><span class="line">                toDisk: <span class="type">Bool</span> = <span class="literal">true</span>,</span><br><span class="line">                completionHandler: ((<span class="type">CacheStoreResult</span>) -&gt; <span class="type">Void</span>)? = <span class="literal">nil</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> identifier = options.processor.identifier</span><br><span class="line">    <span class="keyword">let</span> callbackQueue = options.callbackQueue</span><br><span class="line">    <span class="comment">//创建一个key，用于缓存的键值</span></span><br><span class="line">    <span class="keyword">let</span> computedKey = key.computedKey(with: identifier)</span><br><span class="line">    <span class="comment">//使用内存缓存存储</span></span><br><span class="line">    memoryStorage.storeNoThrow(value: image, forKey: computedKey, expiration: options.memoryCacheExpiration)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">guard</span> toDisk <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果不需要存磁盘，这里就算存储成功里，构建callback</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> completionHandler = completionHandler &#123;</span><br><span class="line">            <span class="keyword">let</span> result = <span class="type">CacheStoreResult</span>(memoryCacheResult: .success(()), diskCacheResult: .success(()))</span><br><span class="line">            callbackQueue.execute &#123; completionHandler(result) &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//io专用的队列，异步将data存入磁盘</span></span><br><span class="line">    ioQueue.async &#123;</span><br><span class="line">        <span class="keyword">let</span> serializer = options.cacheSerializer</span><br><span class="line">        <span class="comment">//将数据序列化</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> data = serializer.data(with: image, original: original) &#123;</span><br><span class="line">            <span class="comment">//调用同步存磁盘的方法，方法的实现是调用磁盘缓存的store方法</span></span><br><span class="line">            <span class="keyword">self</span>.syncStoreToDisk(</span><br><span class="line">                data,</span><br><span class="line">                forKey: key,</span><br><span class="line">                processorIdentifier: identifier,</span><br><span class="line">                callbackQueue: callbackQueue,</span><br><span class="line">                expiration: options.diskCacheExpiration,</span><br><span class="line">                completionHandler: completionHandler)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> completionHandler = completionHandler <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> diskError = <span class="type">KingfisherError</span>.cacheError(</span><br><span class="line">                reason: .cannotSerializeImage(image: image, original: original, serializer: serializer))</span><br><span class="line">            <span class="keyword">let</span> result = <span class="type">CacheStoreResult</span>(</span><br><span class="line">                memoryCacheResult: .success(()),</span><br><span class="line">                diskCacheResult: .failure(diskError))</span><br><span class="line">            callbackQueue.execute &#123; completionHandler(result) &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="流程介绍"><a href="#流程介绍" class="headerlink" title="流程介绍"></a>流程介绍</h2><p>Kingfisher最常用的方式</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"https://example.com/image.png"</span>)</span><br><span class="line">imageView.kf.setImage(with: url)</span><br></pre></td></tr></table></figure>

<p>入口即<code>setImage</code>，从这个方法进去看看</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@discardableResult</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">setImage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    with source: Source?,</span></span></span><br><span class="line"><span class="function"><span class="params">    placeholder: Placeholder? = <span class="literal">nil</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    options: KingfisherOptionsInfo? = <span class="literal">nil</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    progressBlock: DownloadProgressBlock? = <span class="literal">nil</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    completionHandler: <span class="params">(<span class="params">(Result&lt;RetrieveImageResult, KingfisherError&gt;)</span></span></span></span> -&gt; <span class="type">Void</span>)? = <span class="literal">nil</span>) -&gt; <span class="type">DownloadTask?</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> mutatingSelf = <span class="keyword">self</span></span><br><span class="line">    <span class="comment">//没有source直接返回</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> source = source <span class="keyword">else</span> &#123;</span><br><span class="line">        mutatingSelf.placeholder = placeholder</span><br><span class="line">        mutatingSelf.taskIdentifier = <span class="literal">nil</span></span><br><span class="line">        completionHandler?(.failure(<span class="type">KingfisherError</span>.imageSettingError(reason: .emptySource)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理options</span></span><br><span class="line">    <span class="keyword">var</span> options = <span class="type">KingfisherParsedOptionsInfo</span>(<span class="type">KingfisherManager</span>.shared.defaultOptions + (options ?? .empty))</span><br><span class="line">    <span class="keyword">let</span> noImageOrPlaceholderSet = base.image == <span class="literal">nil</span> &amp;&amp; <span class="keyword">self</span>.placeholder == <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> !options.keepCurrentImageWhileLoading || noImageOrPlaceholderSet &#123;</span><br><span class="line">        <span class="comment">// Always set placeholder while there is no image/placeholder yet.</span></span><br><span class="line">        mutatingSelf.placeholder = placeholder</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果有动画，启动动画</span></span><br><span class="line">    <span class="keyword">let</span> maybeIndicator = indicator</span><br><span class="line">    maybeIndicator?.startAnimatingView()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//取自增值作为任务的Identifier</span></span><br><span class="line">    <span class="keyword">let</span> issuedIdentifier = <span class="type">Source</span>.<span class="type">Identifier</span>.next()</span><br><span class="line">    mutatingSelf.taskIdentifier = issuedIdentifier</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> base.shouldPreloadAllAnimation() &#123;</span><br><span class="line">        options.preloadAllAnimationData = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//进度block</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> block = progressBlock &#123;</span><br><span class="line">        options.onDataReceived = (options.onDataReceived ?? []) + [<span class="type">ImageLoadingProgressSideEffect</span>(block)]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> provider = <span class="type">ImageProgressiveProvider</span>(options, refresh: &#123; image <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">self</span>.base.image = image</span><br><span class="line">    &#125;) &#123;</span><br><span class="line">        options.onDataReceived = (options.onDataReceived ?? []) + [provider]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    options.onDataReceived?.forEach &#123;</span><br><span class="line">        $<span class="number">0</span>.onShouldApply = &#123; issuedIdentifier == <span class="keyword">self</span>.taskIdentifier &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//通过KingfisherManager来获取图片</span></span><br><span class="line">    <span class="keyword">let</span> task = <span class="type">KingfisherManager</span>.shared.retrieveImage(</span><br><span class="line">        with: source,</span><br><span class="line">        options: options,</span><br><span class="line">        completionHandler: &#123; result <span class="keyword">in</span></span><br><span class="line">            <span class="type">CallbackQueue</span>.mainCurrentOrAsync.execute &#123;</span><br><span class="line">                maybeIndicator?.stopAnimatingView()</span><br><span class="line">                <span class="comment">//如果拿到图片后，任务已经不是当前任务了，就不处理</span></span><br><span class="line">                <span class="keyword">guard</span> issuedIdentifier == <span class="keyword">self</span>.taskIdentifier <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> reason: <span class="type">KingfisherError</span>.<span class="type">ImageSettingErrorReason</span></span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> value = <span class="keyword">try</span> result.<span class="keyword">get</span>()</span><br><span class="line">                        reason = .notCurrentSourceTask(result: value, error: <span class="literal">nil</span>, source: source)</span><br><span class="line">                    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                        reason = .notCurrentSourceTask(result: <span class="literal">nil</span>, error: error, source: source)</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">let</span> error = <span class="type">KingfisherError</span>.imageSettingError(reason: reason)</span><br><span class="line">                    completionHandler?(.failure(error))</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                mutatingSelf.imageTask = <span class="literal">nil</span></span><br><span class="line">                mutatingSelf.taskIdentifier = <span class="literal">nil</span></span><br><span class="line">                <span class="keyword">switch</span> result &#123;</span><br><span class="line">                <span class="comment">//数据拿到设置image</span></span><br><span class="line">                <span class="keyword">case</span> .success(<span class="keyword">let</span> value):</span><br><span class="line">                    <span class="keyword">guard</span> <span class="keyword">self</span>.needsTransition(options: options, cacheType: value.cacheType) <span class="keyword">else</span> &#123;</span><br><span class="line">                        mutatingSelf.placeholder = <span class="literal">nil</span></span><br><span class="line">                        <span class="keyword">self</span>.base.image = value.image</span><br><span class="line">                        completionHandler?(result)</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">self</span>.makeTransition(image: value.image, transition: options.transition) &#123;</span><br><span class="line">                        completionHandler?(result)</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="comment">//任务失败</span></span><br><span class="line">                <span class="keyword">case</span> .failure:</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">let</span> image = options.onFailureImage &#123;</span><br><span class="line">                        <span class="keyword">self</span>.base.image = image</span><br><span class="line">                    &#125;</span><br><span class="line">                    completionHandler?(result)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    mutatingSelf.imageTask = task</span><br><span class="line">    <span class="keyword">return</span> task</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>流程大概是：</p>
<ul>
<li>UIImageView调用setImage设置图片</li>
<li>通过KingfisherManager.shared.retrieveImage获取图片</li>
<li>KingfisherManager.shared.retrieveImage去查内存缓存，有就返回，没有继续</li>
<li>KingfisherManager.shared.retrieveImage去查磁盘缓存，有就返回，没有继续</li>
<li>KingfisherManager.shared.loadAndCacheImage下载并缓存图片</li>
<li>查看图片中当前的任务和刚执行完的任务是不是同一个，同一个就设置图片，结束</li>
<li>不是同一个，就不处理，结束</li>
</ul>
<p>UIButton的setImage是类似的逻辑，就不多说了</p>
<p>这里需要特别说明的是在tableView中的处理，因为tableView中，快速上下滑动，cell重用。会导致一个UIImageView多次setImage。上面流程中的回设图片中会对比当前task和完成的task，如果不一致，说明这个是之前的某次setImage开启的下载完成了。这是一个对重用的处理细节。</p>
<p>另外当重新滑到之前的位置，setImage的url是开启的，并且没有下载完成，缓存中找不到。这个时候也不会立刻开始下载，而是去看下载任务队列中是否有该url的任务，找到之后，将这个任务绑定到这个UIImageView上。这也是重用的一个场景。</p>
<h2 id="多线程处理"><a href="#多线程处理" class="headerlink" title="多线程处理"></a>多线程处理</h2><p>库中会频繁用到网络请求和磁盘读写，为了不阻塞主线程，很显然需要用到多线程处理。使用URLSession，数据的返回默认会从异步执行。而磁盘的读写则需要我们自己处理，库中创建了一个处理<code>IO</code>的串行队列来处理。</p>
<p>因为这些异步处理，需要一些手段保证数据的一致性。下面列举一下临界区。</p>
<p><code>KingfisherManager</code>是一个单例，所有<code>UIImageView</code>，<code>UIButton</code>的<code>setImage</code>操作都是通过它来完成。<code>KingfisherManager</code>中有一个<code>ImageCache</code>和一个<code>downloader</code>。<code>cache</code>中的内存缓存是一个<code>NSCache</code>对象，全局的存取到会用到。</p>
<p><code>downloader</code>中下载会返回一个task，这些task会在sessionDelegate中管理。<code>private var tasks: [URL: SessionDataTask] = [:]</code></p>
<p><code>SessionDataTask</code>中保存了该任务的回调信息</p>
<p>多线程会导致一些同步问题，从网络下载完图片，会在未知线程缓存，接下来缓存时，有可能遇到其他任务正在读取缓存的情况。所以内存缓存的写入时加锁处理的。</p>
<p>库中多用队列来处理任务。流程中可能出现的多线程问题：</p>
<ul>
<li>同个文件的读写</li>
</ul>
<p>请求的起点一般是从<code>UIImageView.setImage</code>开始的，这个方法的调用一般是在主线程中发起。这个方法拿到数据后，<code>completionHandler</code>是通过<code>CallbackQueue.mainCurrentOrAsync</code>在主线程中执行。</p>
<p>在获取数据，会先查内存缓存，在查磁盘缓存。内存缓存的查询比较快，会在当前线程知节执行。磁盘缓存的查询，会使用一个单独的串行队列完成。</p>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h4 id="Delegate-lt-Input-Output-gt"><a href="#Delegate-lt-Input-Output-gt" class="headerlink" title="Delegate&lt;Input, Output&gt;"></a>Delegate&lt;Input, Output&gt;</h4><p>Kingfisher 中使用Delegate类来包装block，添加<code>[weak self]</code>来避免 retain cycle。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Delegate</span>&lt;<span class="title">Input</span>, <span class="title">Output</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">init</span>() &#123;&#125;    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> block: ((<span class="type">Input</span>) -&gt; <span class="type">Output?</span>)?    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">delegate</span>&lt;T: AnyObject&gt;<span class="params">(on target: T, block: <span class="params">(<span class="params">(T, Input)</span></span></span></span> -&gt; <span class="type">Output</span>)?) &#123;</span><br><span class="line">        <span class="keyword">self</span>.block = &#123; [<span class="keyword">weak</span> target] input <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> target = target <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">            <span class="keyword">return</span> block?(target, input)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">call</span><span class="params">(<span class="number">_</span> input: Input)</span></span> -&gt; <span class="type">Output?</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> block?(input)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>delegate方法，将传入的block包装成自己的block，中间加入weak处理。call方法则是调用这个block。</p>
<h4 id="defer的使用"><a href="#defer的使用" class="headerlink" title="defer的使用"></a>defer的使用</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addCallback</span><span class="params">(<span class="number">_</span> callback: TaskCallback)</span></span> -&gt; <span class="type">CancelToken</span> &#123;</span><br><span class="line">    lock.lock()</span><br><span class="line">    <span class="keyword">defer</span> &#123; lock.unlock() &#125;</span><br><span class="line">    callbacksStore[currentToken] = callback</span><br><span class="line">    <span class="keyword">defer</span> &#123; currentToken += <span class="number">1</span> &#125;</span><br><span class="line">    <span class="keyword">return</span> currentToken</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二个<code>defer</code>调用之后，返回的currentToken，值是+1之前的。<strong>所以deffer的调用时机，其实是返回之后。</strong></p>
<blockquote>
<p>从语言设计上来说，<code>defer</code> 的目的就是进行资源清理和避免重复的返回前需要执行的代码，而不是用来以取巧地实现某些功能。这样做只会让代码可读性降低。</p>
</blockquote>
<p>上边这段话是作者在<a href="https://onevcat.com/2018/11/defer/" target="_blank" rel="noopener">关于 Swift defer 的正确使用</a>中说的话，然后还是在kingfisher中用了。一个小趣点。</p>
<p>另外这篇文章中还提到了作用域的问题，<strong>defer这个词，并不是在方法返回后执行的。而是所在的作用域结束后返回的</strong>。比如你在if语句中写defer，那这个defer就是在if之后执行。不是在方法返回之后。文中有具体例子，可以细看。</p>
<p>这里使用了多个defer，之前没见过，查了下，<strong>多个defer的调用会以反序执行</strong>，类似入栈，出栈，网上有个很不错的例子，这里看一下。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> database = openDatabase(...) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"><span class="keyword">defer</span> &#123; closeDatabase(database) &#125;</span><br><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> connection = openConnection(database) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125; </span><br><span class="line"><span class="keyword">defer</span> &#123; closeConnection(connection) &#125;</span><br><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> result = runQuery(connection, ...) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br></pre></td></tr></table></figure>

<p>打开一个数据库，打开一个连接，结束之后，defer反序执行，先关掉连接，在关数据库。很恰当。</p>
<h4 id="GCD的使用"><a href="#GCD的使用" class="headerlink" title="GCD的使用"></a>GCD的使用</h4><p>库中对GCD的使用，是包装了一个<code>CallbackQueue</code>。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">CallbackQueue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> mainAsync</span><br><span class="line">    <span class="keyword">case</span> mainCurrentOrAsync</span><br><span class="line">    <span class="keyword">case</span> untouch</span><br><span class="line">    <span class="keyword">case</span> dispatch(<span class="type">DispatchQueue</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">execute</span><span class="params">(<span class="number">_</span> block: @escaping <span class="params">()</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> .mainAsync:</span><br><span class="line">            <span class="type">DispatchQueue</span>.main.async &#123; block() &#125;</span><br><span class="line">        <span class="keyword">case</span> .mainCurrentOrAsync:</span><br><span class="line">            <span class="type">DispatchQueue</span>.main.safeAsync &#123; block() &#125;</span><br><span class="line">        <span class="keyword">case</span> .untouch:</span><br><span class="line">            block()</span><br><span class="line">        <span class="keyword">case</span> .dispatch(<span class="keyword">let</span> queue):</span><br><span class="line">            queue.async &#123; block() &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> queue: <span class="type">DispatchQueue</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> .mainAsync: <span class="keyword">return</span> .main</span><br><span class="line">        <span class="keyword">case</span> .mainCurrentOrAsync: <span class="keyword">return</span> .main</span><br><span class="line">        <span class="keyword">case</span> .untouch: <span class="keyword">return</span> <span class="type">OperationQueue</span>.current?.underlyingQueue ?? .main</span><br><span class="line">        <span class="keyword">case</span> .dispatch(<span class="keyword">let</span> queue): <span class="keyword">return</span> queue</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从execute的实现可以了解这几个枚举的含义。有一个是没出现过的，就是safeAsync。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">DispatchQueue</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This method will dispatch the `block` to self.</span></span><br><span class="line">    <span class="comment">// If `self` is the main queue, and current thread is main thread, the block</span></span><br><span class="line">    <span class="comment">// will be invoked immediately instead of being dispatched.</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">safeAsync</span><span class="params">(<span class="number">_</span> block: @escaping <span class="params">()</span></span></span>-&gt;()) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span> === <span class="type">DispatchQueue</span>.main &amp;&amp; <span class="type">Thread</span>.isMainThread &#123;</span><br><span class="line">            block()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            async &#123; block() &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个safeAsync里会先判断当前是不是主队列和主线程。如果是主线程，主队列，就直接执行block，不然就async执行该block。这个方法只在上面的<code>mainCurrentOrAsync</code>由主队列调用，感觉这样写不是特别好，或者名字不是特别恰当。因为这个方法是加载DispatchQueue上的，所以其他队列也是可以调用的，但是非主队列调用，都是有问题的。这个方法的声明的范围太广了。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/源码/" rel="tag"># 源码</a>
          
            <a href="/tags/Swift/" rel="tag"># Swift</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/26/rsa加密/" rel="next" title="rsa加密">
                <i class="fa fa-chevron-left"></i> rsa加密
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/18/PLeakSniffer源码阅读/" rel="prev" title="PLeakSniffer 源码阅读">
                PLeakSniffer 源码阅读 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">冰川</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#模块介绍"><span class="nav-number">1.</span> <span class="nav-text">模块介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通用模块"><span class="nav-number">1.1.</span> <span class="nav-text">通用模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ImageSource"><span class="nav-number">1.1.1.</span> <span class="nav-text">ImageSource</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KingfisherError"><span class="nav-number">1.1.2.</span> <span class="nav-text">KingfisherError</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#图片处理"><span class="nav-number">1.2.</span> <span class="nav-text">图片处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#模糊"><span class="nav-number">1.2.1.</span> <span class="nav-text">模糊</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存"><span class="nav-number">1.3.</span> <span class="nav-text">缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存策略"><span class="nav-number">1.3.1.</span> <span class="nav-text">缓存策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内存缓存"><span class="nav-number">1.3.2.</span> <span class="nav-text">内存缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#磁盘缓存"><span class="nav-number">1.3.3.</span> <span class="nav-text">磁盘缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#文件操作"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">文件操作</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ImageCache"><span class="nav-number">1.3.4.</span> <span class="nav-text">ImageCache</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流程介绍"><span class="nav-number">2.</span> <span class="nav-text">流程介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多线程处理"><span class="nav-number">3.</span> <span class="nav-text">多线程处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#补充"><span class="nav-number">4.</span> <span class="nav-text">补充</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Delegate-lt-Input-Output-gt"><span class="nav-number">4.0.1.</span> <span class="nav-text">Delegate&lt;Input, Output&gt;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#defer的使用"><span class="nav-number">4.0.2.</span> <span class="nav-text">defer的使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GCD的使用"><span class="nav-number">4.0.3.</span> <span class="nav-text">GCD的使用</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">冰川</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.2</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/affix.js?v=7.1.2"></script>

  <script src="/js/schemes/pisces.js?v=7.1.2"></script>



  
  <script src="/js/scrollspy.js?v=7.1.2"></script>
<script src="/js/post-details.js?v=7.1.2"></script>



  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
